<%- include("../../views/partials/admin/header") %>
<head>
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/sweetalert2@10/dist/sweetalert2.min.css"
  />
  <link
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    rel="stylesheet"
  />
  <style>
    body {
      background-color: #f8f9fa;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
        sans-serif;
    }

    .content-header {
      background-color: #fff;
      padding: 15px 20px;
      border-bottom: 1px solid #dee2e6;
      margin-bottom: 20px;
    }

    .content-title {
      font-size: 24px;
      font-weight: 600;
      margin: 0;
      color: #2c3e50;
    }

    .card-header {
      background: #fff;
      padding: 15px 20px;
      border-bottom: 1px solid #dee2e6;
      margin-bottom: 20px;
    }

    .input-group {
      max-width: 400px;
    }

    .form-control {
      border: 1px solid #ced4da;
      border-radius: 6px;
      padding: 8px 12px;
      font-size: 14px;
    }

    .form-control:focus {
      border-color: #6c757d;
      box-shadow: 0 0 0 0.2rem rgba(108, 117, 125, 0.25);
    }

    .btn {
      font-size: 13px;
      padding: 6px 12px;
      border-radius: 4px;
      font-weight: 500;
    }

    .btn-primary {
      background-color: #6c757d;
      border-color: #6c757d;
    }

    .btn-primary:hover {
      background-color: #5a6268;
      border-color: #545b62;
    }

    .btn-info {
      background-color: #17a2b8;
      border-color: #17a2b8;
    }

    .btn-info:hover {
      background-color: #138496;
      border-color: #117a8b;
    }

    .btn-danger {
      background-color: #dc3545;
      border-color: #dc3545;
    }

    .btn-danger:hover {
      background-color: #c82333;
      border-color: #bd2130;
    }

    .btn-success {
      background-color: #28a745;
      border-color: #28a745;
    }

    .btn-success:hover {
      background-color: #218838;
      border-color: #1e7e34;
    }

    .right {
      padding: 0 20px;
      margin-top: 0;
    }

    .table {
      background: #fff;
      border: 1px solid #dee2e6;
      border-radius: 6px;
      overflow: hidden;
      font-size: 14px;
    }

    .table thead th {
      background-color: #f8f9fa;
      color: #495057;
      font-weight: 600;
      font-size: 13px;
      padding: 12px 8px;
      border-bottom: 1px solid #dee2e6;
    }

    .table tbody td {
      padding: 10px 8px;
      vertical-align: middle;
      border-bottom: 1px solid #f1f3f4;
    }

    .table tbody tr:hover {
      background-color: #f8f9fa;
    }

    .table tbody td img {
      width: 45px;
      height: 45px;
      object-fit: cover;
      border-radius: 4px;
      border: 1px solid #dee2e6;
    }

    .variants-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .variants-list li {
      background: #f8f9fa;
      padding: 2px 6px;
      margin: 1px 0;
      border-radius: 3px;
      font-size: 11px;
      display: inline-block;
      margin-right: 3px;
      border: 1px solid #e9ecef;
    }

    .offer-badge {
      background-color: #fff3cd;
      color: #856404;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 11px;
      font-weight: 500;
      border: 1px solid #ffeaa7;
    }

    .category-badge {
      background-color: #d1ecf1;
      color: #0c5460;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 500;
      border: 1px solid #bee5eb;
    }

    .price-text {
      font-weight: 600;
      color: #28a745;
      font-size: 14px;
    }

    .brand-name {
      color: #6c757d;
      font-size: 13px;
    }

    .product-name {
      font-weight: 500;
      color: #495057;
      font-size: 13px;
    }

    .pagination {
      justify-content: center;
      margin-top: 20px;
    }

    .page-link {
      color: #6c757d;
      border: 1px solid #dee2e6;
      padding: 6px 12px;
      font-size: 14px;
    }

    .page-link:hover {
      color: #495057;
      background-color: #f8f9fa;
      border-color: #dee2e6;
    }

    .page-item.active .page-link {
      background-color: #6c757d;
      border-color: #6c757d;
      color: #fff;
    }

    .btn a {
      color: inherit;
      text-decoration: none;
    }

    .btn a:hover {
      color: inherit;
    }

    @media (max-width: 768px) {
      .card-header {
        flex-direction: column;
        gap: 10px;
      }

      .input-group {
        max-width: 100%;
      }

      .right {
        padding: 0 10px;
      }

      .table {
        font-size: 12px;
      }

      .table thead th {
        padding: 8px 4px;
        font-size: 11px;
      }

      .table tbody td {
        padding: 8px 4px;
      }
    }
  </style>
</head>

<div class="content-header">
  <h2 class="content-title">Products</h2>
</div>

<header
  class="card-header d-flex justify-content-between align-items-center mb-4 px-4"
>
  <form action="" method="get" class="d-inline">
    <div
      class="input-group input-group-sm border border-1 border-grey rounded-pill"
      style="width: 400px"
    >
      <input
        type="text"
        class="form-control border-0 rounded-pill"
        placeholder="Search products or brands"
        name="search"
      />
      <button class="btn border-0" type="submit">Search</button>
    </div>
  </form>

  <a
    href="/admin/addProducts"
    class="btn btn-primary"
    style="border-radius: 20px"
    >+ Add Product</a
  >
</header>

<div class="right mt-5">
  <table class="table table-striped">
    <thead>
      <tr>
        <th scope="col">Product</th>
        <th scope="col">Product name</th>
        <th scope="col">Brand</th>
        <th scope="col">Category</th>
        <th scope="col">Sale Price</th>
        <th scope="col">Offer Price</th>
        <th scope="col">Variant / Quantity</th>
        <th scope="col">Offer</th>
        <th scope="col">Action</th>
        <th scope="col">Edit</th>
      </tr>
    </thead>
    <tbody>
      <% for (let i = 0; i < data.length; i++) { %>
      <tr data-product-id="<%= data[i]._id %>">
        <td>
          <img
            src="<%= data[i].productImages[0] %>"
            alt="Product"
            class="me-3"
            style="
              width: 45px;
              height: 45px;
              object-fit: cover;
              border-radius: 4px;
            "
          />
        </td>
        <td class="product-name"><%=data[i].productName%></td>
        <td class="brand-name"><%=data[i].brand%></td>
        <td><span class="category-badge"><%=data[i].category.name%></span></td>
        <td class="price-text">â‚¹<%=data[i].salePrice%></td>
        <td>
          <%if(locals.data[i].productOffer){%>
          <span class="offer-badge"><%=data[i].productOffer%>%</span>
          <%}else{%>
          <span class="offer-badge">0%</span>
          <%}%>
        </td>
        <td>
          <ul class="mb-5 ps-3 variants-list">
            <% if (data[i].variants) { %> <% // Convert Map to Object if needed
            const variants = data[i].variants instanceof Map ?
            Object.fromEntries(data[i].variants) : data[i].variants; %> <%
            Object.entries(variants).forEach(([size, quantity]) => { %>
            <li><%= size %>: <%= quantity %></li>
            <% }) %> <% } %>
          </ul>
        </td>
        <td>
          <% if (locals.data[i].productOffer === 0) { %>
          <button
            class="btn btn-info text-white open-offer-modal"
            data-product-id="<%=data[i]._id%>"
            data-product-name="<%=data[i].productName%>"
            style="width: 90px"
            type="button"
          >
            Add Offer
          </button>
          <%}else{%>
          <button
            class="btn btn-info text-white"
            onclick="removerOffer('<%=data[i]._id%>')"
            style="width: 90px"
          >
            Remove
          </button>
          <%}%>
        </td>
        <td>
          <%if(data[i].isBlocked===false){%>
          <button 
            class="btn btn-danger block-product-btn" 
            style="width: 70px"
            data-product-id="<%=data[i]._id%>"
            data-product-name="<%=data[i].productName%>"
          >
            <span class="text-white">Block</span>
          </button>
          <%}else{%>
          <button 
            class="btn btn-success unblock-product-btn" 
            style="width: 70px"
            data-product-id="<%=data[i]._id%>"
            data-product-name="<%=data[i].productName%>"
          >
            <span class="text-white">Unblock</span>
          </button>
          <%}%>
        </td>
        <td>
          <button class="btn btn-info" style="width: 70px">
            <a
              href="/admin/editProduct?id=<%=data[i]._id%>"
              class="text-white"
              style="text-decoration: none"
              >Edit</a
            >
          </button>
        </td>
      </tr>
      <%}%>
    </tbody>
  </table>
</div>

<div class="container mt-3">
  <nav aria-label="Page navigation">
    <ul
      class="pagination justify-content-center mb-20"
      style="margin-right: 200px"
    >
      <% for (let i = 1; i <= totalPages; i++) { %>
      <li class="page-item <%=(i === currentPage) ? 'active' : '' %>">
        <a class="page-link" href="?page=<%= i %>"><%= i %></a>
      </li>
      <% } %>
    </ul>
  </nav>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@10/dist/sweetalert2.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

<style>
  /* Loading state styles */
  .btn-loading {
    position: relative;
    pointer-events: none;
    opacity: 0.7;
  }

  .btn-loading::after {
    content: '';
    position: absolute;
    width: 16px;
    height: 16px;
    margin: auto;
    border: 2px solid transparent;
    border-top-color: #ffffff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
  }

  @keyframes spin {
    0% { transform: translate(-50%, -50%) rotate(0deg); }
    100% { transform: translate(-50%, -50%) rotate(360deg); }
  }

  /* Custom Toast notification styles - Override Bootstrap */
  #customToastContainer {
    position: fixed !important;
    top: 20px !important;
    right: 20px !important;
    z-index: 99999 !important;
    pointer-events: none !important;
    width: auto !important;
    max-width: none !important;
  }

  #customToastContainer .custom-toast {
    background: white !important;
    border-radius: 8px !important;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2) !important;
    margin-bottom: 15px !important;
    padding: 16px 20px !important;
    min-width: 320px !important;
    max-width: 400px !important;
    border-left: 4px solid !important;
    animation: customSlideIn 0.4s ease-out !important;
    pointer-events: auto !important;
    position: relative !important;
    opacity: 1 !important;
    transform: translateX(0) !important;
    width: auto !important;
    font-size: 14px !important;
    background-color: white !important;
    background-clip: unset !important;
    border: none !important;
    border-radius: 8px !important;
  }

  #customToastContainer .custom-toast.success {
    border-left-color: #28a745 !important;
    background: linear-gradient(135deg, #f8fff9 0%, #ffffff 100%) !important;
  }

  #customToastContainer .custom-toast.error {
    border-left-color: #dc3545 !important;
    background: linear-gradient(135deg, #fff8f8 0%, #ffffff 100%) !important;
  }

  #customToastContainer .custom-toast.warning {
    border-left-color: #ffc107 !important;
    background: linear-gradient(135deg, #fffef8 0%, #ffffff 100%) !important;
  }

  @keyframes customSlideIn {
    from {
      transform: translateX(100%) !important;
      opacity: 0 !important;
    }
    to {
      transform: translateX(0) !important;
      opacity: 1 !important;
    }
  }

  @keyframes customSlideOut {
    from {
      transform: translateX(0) !important;
      opacity: 1 !important;
    }
    to {
      transform: translateX(100%) !important;
      opacity: 0 !important;
    }
  }

  #customToastContainer .custom-toast.fade-out {
    animation: customSlideOut 0.3s ease-in forwards !important;
  }

  #customToastContainer .custom-toast-header {
    display: flex !important;
    justify-content: space-between !important;
    align-items: center !important;
    margin-bottom: 8px !important;
    padding: 0 !important;
    background: none !important;
    border: none !important;
  }

  #customToastContainer .custom-toast-title {
    font-weight: 600 !important;
    font-size: 15px !important;
    color: #333 !important;
  }

  #customToastContainer .custom-toast-close {
    background: none !important;
    border: none !important;
    font-size: 20px !important;
    cursor: pointer !important;
    color: #999 !important;
    padding: 0 !important;
    width: 24px !important;
    height: 24px !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    border-radius: 50% !important;
    transition: all 0.2s ease !important;
    margin: 0 !important;
  }

  #customToastContainer .custom-toast-close:hover {
    background-color: #f0f0f0 !important;
    color: #666 !important;
  }

  #customToastContainer .custom-toast-message {
    font-size: 14px !important;
    color: #555 !important;
    line-height: 1.4 !important;
    padding: 0 !important;
    word-wrap: break-word !important;
  }

  /* Ensure toasts are always visible */
  #customToastContainer * {
    box-sizing: border-box !important;
  }
</style>

<!-- Custom Toast Container -->
<div id="customToastContainer"></div>

<!-- Add Offer Modal -->
<div class="modal fade" id="addOfferModal" tabindex="-1" aria-labelledby="addOfferModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addOfferModalLabel">Add Offer to Product</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="addOfferForm">
          <input type="hidden" id="offerProductId" name="productId">
          <div class="mb-3">
            <label for="offerProductName" class="form-label">Product</label>
            <input type="text" class="form-control" id="offerProductName" readonly>
          </div>
          <div class="mb-3">
            <label for="offerPercentage" class="form-label">Offer Percentage (%)</label>
            <input type="number" class="form-control" id="offerPercentage" name="percentage" min="1" max="100" required>
            <div id="offerError" class="text-danger mt-1" style="display:none;"></div>
          </div>
          <button type="submit" class="btn btn-primary">Add Offer</button>
        </form>
      </div>
    </div>
  </div>
</div>
<script>
$(document).ready(function() {
  // Open modal and set product info
  $('.open-offer-modal').on('click', function() {
    const productId = $(this).data('product-id');
    const productName = $(this).data('product-name');
    $('#offerProductId').val(productId);
    $('#offerProductName').val(productName);
    $('#offerPercentage').val('');
    $('#offerError').text('').hide();
    $('#offerPercentage').removeClass('is-invalid');
    $('#addOfferModal').modal('show');
  });

  // Handle form submit
  $('#addOfferForm').on('submit', function(e) {
    e.preventDefault();
    const productId = $('#offerProductId').val();
    const percentage = $('#offerPercentage').val();
    $('#offerError').text('').hide();
    $('#offerPercentage').removeClass('is-invalid');
    if (!percentage || isNaN(percentage) || percentage < 1 || percentage > 100) {
      $('#offerError').text('Please enter a valid offer percentage between 1 and 100.').show();
      $('#offerPercentage').addClass('is-invalid');
      return;
    }
    $.ajax({
      url: '/admin/addProductOffer',
      method: 'POST',
      data: { productId, percentage },
      success: function(response) {
        if (response.status === true) {
          $('#addOfferModal').modal('hide');
          Swal.fire('Offer Added', 'The offer has been successfully added.', 'success').then(() => location.reload());
        } else {
          $('#offerError').text(response.message || 'Unable to add offer. Please try again.').show();
          $('#offerError').addClass('text-danger');
          $('#offerPercentage').addClass('is-invalid');
        }
      },
      error: function(xhr) {
        let msg = 'Something went wrong while adding the offer. Please try again.';
        if (xhr.responseJSON && xhr.responseJSON.message) {
          msg = xhr.responseJSON.message;
        }
        $('#offerError').text(msg).show();
        $('#offerError').addClass('text-danger');
        $('#offerPercentage').addClass('is-invalid');
      }
    });
  });
});

// Add this function to handle Remove Offer
function removerOffer(productId) {
  Swal.fire({
    title: 'Remove Offer',
    text: 'Are you sure you want to remove the offer from this product?',
    icon: 'warning',
    showCancelButton: true,
    confirmButtonText: 'Yes, remove it!',
    cancelButtonText: 'Cancel'
  }).then((result) => {
    if (result.isConfirmed) {
      $.ajax({
        url: '/admin/removeProductOffer',
        method: 'POST',
        data: { productId },
        success: function(response) {
          if (response.status === true) {
            Swal.fire('Offer Removed', 'The offer has been removed from the product.', 'success').then(() => location.reload());
          } else {
            Swal.fire('Failed', response.message || 'Unable to remove offer. Please try again.', 'error');
          }
        },
        error: function(xhr) {
          let msg = 'Something went wrong while removing the offer. Please try again.';
          if (xhr.responseJSON && xhr.responseJSON.message) {
            msg = xhr.responseJSON.message;
          }
          Swal.fire('Error', msg, 'error');
        }
      });
    }
  });
}
</script>

<%- include("../../views/partials/admin/footer") %>
