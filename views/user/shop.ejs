<%- include("../../views/partials/user/header") %>

<!-- Google Font -->
<link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@300;400;600;700;800;900&display=swap"
rel="stylesheet">

<!-- Css Styles -->
<link rel="stylesheet" href="css/bootstrap.min.css" type="text/css">
<link rel="stylesheet" href="css/font-awesome.min.css" type="text/css">
<link rel="stylesheet" href="css/elegant-icons.css" type="text/css">
<link rel="stylesheet" href="css/magnific-popup.css" type="text/css">
<link rel="stylesheet" href="css/nice-select.css" type="text/css">
<link rel="stylesheet" href="css/owl.carousel.min.css" type="text/css">
<link rel="stylesheet" href="css/slicknav.min.css" type="text/css">
<link rel="stylesheet" href="css/style.css" type="text/css">

<style>
        .checkbox-container {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            cursor: pointer;
            font-size: 15px;
        }
        
        .checkbox-container input[type="checkbox"] {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            width: 18px;
            height: 18px;
            border: 1px solid #ddd;
            border-radius: 2px;
            margin-right: 10px;
            position: relative;
            top: 0;
            background-color: white;
            cursor: pointer;
        }
        
        .checkbox-container input[type="checkbox"]:checked {
            background-color: #000;
            border-color: #000;
        }
        
        .checkbox-container input[type="checkbox"]:checked::after {
            content: '';
            position: absolute;
            left: 6px;
            top: 2px;
            width: 5px;
            height: 10px;
            border: solid white;
            border-width: 0 2px 2px 0;
            transform: rotate(45deg);
        }
        
        .nice-scroll {
            max-height: 200px;
            overflow-y: auto;
        }
        
        .shop__sidebar__categories ul,
        .shop__sidebar__brand ul,
        .shop__sidebar__price ul {
            padding-left: 5px;
            margin-top: 10px;
        }
        
        .shop__sidebar__categories li,
        .shop__sidebar__brand li,
        .shop__sidebar__price li {
            list-style: none;
        }
        
        .shop__sidebar__filter__btn {
            display: none;
        }
        
        .filter-loading {
            display: none;
            text-align: center;
            padding: 10px 0;
        }
        
        .filter-loading i {
            animation: spin 1s infinite linear;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .card-heading a {
            font-weight: 600;
            font-size: 16px;
            color: #111;
            display: block;
            padding: 10px 0;
            text-decoration: none;
        }
        
        .card {
            border: none;
            margin-bottom: 15px;
        }
        
        .card-body {
            padding: 0 0 15px 0;
        }

        .wishlist-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            margin-right: 5px;
            background-color: white;
            padding: 5px;
            border-radius: 50%;
            color: #0f0e0e;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            font-size: 16px;
            z-index: 10;
            transition: 0.3s ease;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Mobile Filter Button */
        .mobile-filter-btn {
            display: none;
            background: #000;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .mobile-filter-btn:hover {
            background: #333;
        }

        .mobile-filter-btn i {
            margin-right: 8px;
        }

        .filter-count {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ff4444;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        /* Clear filters button */
        .clear-filters-btn {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            color: #6c757d;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .clear-filters-btn:hover {
            background: #e9ecef;
            color: #495057;
        }

        .clear-filters-btn i {
            margin-right: 5px;
        }

        /* Desktop styles (default) - sidebar stays in column */
        @media (min-width: 992px) {
            .shop__sidebar__search {
                position: static;
                transform: none;
                box-shadow: none;
                z-index: auto;
                width: 100%;
                height: auto;
                overflow-y: visible;
                background: transparent;
            }
        }

        /* Mobile and Tablet styles - sidebar becomes slide-out panel */
        @media (max-width: 991.98px) {
            .mobile-filter-btn {
                display: inline-block;
            }

            .shop__sidebar__search {
                position: fixed;
                top: 0;
                left: -100%;
                width: 320px;
                max-width: 85vw;
                height: 100vh;
                background: white;
                z-index: 1050;
                box-shadow: 2px 0 10px rgba(0,0,0,0.1);
                overflow-y: auto;
                padding: 20px;
                transition: left 0.3s ease;
            }

            .shop__sidebar__search.active {
                left: 0;
            }

            /* Close button for mobile */
            .mobile-close-btn {
                position: absolute;
                top: 15px;
                right: 15px;
                background: none;
                border: none;
                font-size: 24px;
                color: #666;
                cursor: pointer;
                width: 40px;
                height: 40px;
                display: flex;
                align-items: center;
                justify-content: center;
                border-radius: 50%;
                transition: all 0.3s ease;
            }

            .mobile-close-btn:hover {
                background: #f5f5f5;
                color: #000;
            }

            /* Mobile sidebar header */
            .mobile-sidebar-header {
                padding-top: 50px;
                margin-bottom: 20px;
                border-bottom: 1px solid #eee;
                padding-bottom: 15px;
            }

            .mobile-sidebar-header h5 {
                margin: 0;
                font-weight: 600;
                color: #333;
            }
        }

        /* Overlay for mobile */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1040;
            transition: opacity 0.3s ease;
        }

        .sidebar-overlay.active {
            display: block;
        }

        /* Prevent body scrolling when sidebar is open */
        body.overflow-hidden {
            overflow: hidden;
        }

        /* Demo styles for layout demonstration */
        .demo-products {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            min-height: 500px;
        }

        .product-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: relative;
        }

        /* Fix container margins and padding to remove white space */
        .shop .container {
            max-width: 100% !important;
            padding-left: 15px !important;
            padding-right: 15px !important;
            margin-left: auto !important;
            margin-right: auto !important;
        }

        /* Ensure full width on larger screens */
        @media (min-width: 1200px) {
            .shop .container {
                max-width: 1200px !important;
            }
        }

        @media (min-width: 992px) and (max-width: 1199px) {
            .shop .container {
                max-width: 960px !important;
            }
        }

        @media (min-width: 768px) and (max-width: 991px) {
            .shop .container {
                max-width: 720px !important;
            }
        }

        @media (max-width: 767px) {
            .shop .container {
                max-width: 100% !important;
                padding-left: 10px !important;
                padding-right: 10px !important;
            }
        }
    </style>


<section class="shop spad">
    <div class="container">
        <div class="row">
            <div class="col-lg-3">
                <!-- Mobile Filter Button (only shows on small screens) -->
                <button class="mobile-filter-btn" id="mobileFilterBtn">
                    <i class="fas fa-filter"></i>
                    Filters
                    <% if (filters && (filters.selectedCategories.length > 0 || filters.selectedBrands.length > 0 || filters.selectedPriceRanges.length > 0 || filters.search)) { %>
                        <span class="filter-count">
                            <%= (filters.selectedCategories.length + filters.selectedBrands.length + filters.selectedPriceRanges.length + (filters.search ? 1 : 0)) %>
                        </span>
                    <% } %>
                </button>

                <!-- Filter Sidebar -->
                <div class="shop__sidebar__search" id="filterSidebar">
                    <!-- Mobile Close Button (only shows on small screens) -->
                    <button class="mobile-close-btn d-lg-none" id="closeSidebarBtn">
                        <i class="fas fa-times"></i>
                    </button>

                    <!-- Mobile Sidebar Header (only shows on small screens) -->
                    <div class="mobile-sidebar-header d-lg-none">
                        <h5>Filter Products</h5>
                    </div>

                    <!-- Sort option moved to top -->
                    <div class="shop__product__option mb-3">
                        <div class="row">
                            <div class="col-lg-12">
                                <div class="shop__product__option__right">
                                    <select id="sortSelect" name="sort" onchange="sortProducts()">
                                        <option value="">Sort By Price or Name</option>  
                                        <option value="ascending" <%= filters && filters.sort === 'ascending' ? 'selected' : '' %>>Price: Low To High</option>
                                        <option value="descending" <%= filters && filters.sort === 'descending' ? 'selected' : '' %>>Price: High To Low</option>
                                        <option value="name_asc" <%= filters && filters.sort === 'name_asc' ? 'selected' : '' %>>Name: aA - zZ</option>
                                        <option value="name_dsc" <%= filters && filters.sort === 'name_dsc' ? 'selected' : '' %>>Name: zZ - aA</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="shop__sidebar">
                        <!-- Search input -->
                        <div class="mb-2 d-flex align-items-center border rounded">
                            <input type="text" id="searchInput" name="query" placeholder="Search products..." value="<%= filters && filters.search ? filters.search : '' %>" class="form-control border-0 flex-grow-1">
                            <button type="button" id="searchBtn" class="btn border-0 bg-transparent px-3">
                                <span class="icon_search"></span>
                            </button>
                        </div>
                        
                        <div class="shop__sidebar__accordion">
                            <div class="accordion" id="accordionExample">  
                                <!-- Categories -->
                                <div class="card">
                                    <div class="card-heading">
                                        <a data-toggle="collapse" data-target="#collapseOne">
                                            CATEGORIES
                                        </a>
                                    </div>
                                    <div id="collapseOne" class="collapse show" data-parent="#accordionExample">
                                        <div class="card-body">
                                            <div class="shop__sidebar__categories">
                                                <ul class="nice-scroll">
                                                    <% for(let i=0; i<category.length; i++) { %>
                                                        <li class="<%= filters && filters.selectedCategories.includes(category[i]._id.toString()) ? 'filter-active' : '' %>">
                                                            <label class="checkbox-container">
                                                                <input type="checkbox" 
                                                                       class="auto-filter" 
                                                                       name="category" 
                                                                       value="<%= category[i]._id %>"
                                                                       <%= filters && filters.selectedCategories.includes(category[i]._id.toString()) ? 'checked' : '' %>>
                                                                <%= category[i].name %>
                                                            </label>
                                                        </li>
                                                    <% } %>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Brands -->
                                <div class="card">
                                    <div class="card-heading">
                                        <a data-toggle="collapse" data-target="#collapseTwo">
                                            BRANDING
                                        </a>
                                    </div>
                                    <div id="collapseTwo" class="collapse show" data-parent="#accordionExample">
                                        <div class="card-body">
                                            <div class="shop__sidebar__brand">
                                                <ul>
                                                    <% for(let i=0; i<brand.length; i++) { %>
                                                        <li class="<%= filters && filters.selectedBrands.includes(brand[i]._id.toString()) ? 'filter-active' : '' %>">
                                                            <label class="checkbox-container">
                                                                <input type="checkbox" 
                                                                       class="auto-filter" 
                                                                       name="brand" 
                                                                       value="<%= brand[i]._id %>"
                                                                       <%= filters && filters.selectedBrands.includes(brand[i]._id.toString()) ? 'checked' : '' %>>
                                                                <%= brand[i].brandName %>
                                                            </label>
                                                        </li>
                                                    <% } %>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Price Filter -->
                                <div class="card">
                                    <div class="card-heading">
                                        <a data-toggle="collapse" data-target="#collapseThree">
                                            FILTER PRICE
                                        </a>
                                    </div>
                                    <div id="collapseThree" class="collapse show" data-parent="#accordionExample">
                                        <div class="card-body">
                                            <div class="shop__sidebar__price">
                                                <ul>
                                                    <li class="<%= filters && filters.selectedPriceRanges.includes('0-500') ? 'filter-active' : '' %>">
                                                        <label class="checkbox-container">
                                                            <input type="checkbox" 
                                                                   class="auto-filter" 
                                                                   name="price" 
                                                                   value="0-500"
                                                                   <%= filters && filters.selectedPriceRanges.includes('0-500') ? 'checked' : '' %>>
                                                            â‚¹0.00 - â‚¹500.00
                                                        </label>
                                                    </li>
                                                    <li class="<%= filters && filters.selectedPriceRanges.includes('500-1000') ? 'filter-active' : '' %>">
                                                        <label class="checkbox-container">
                                                            <input type="checkbox" 
                                                                   class="auto-filter" 
                                                                   name="price" 
                                                                   value="500-1000"
                                                                   <%= filters && filters.selectedPriceRanges.includes('500-1000') ? 'checked' : '' %>>
                                                            â‚¹500.00 - â‚¹1000.00
                                                        </label>
                                                    </li>
                                                    <li class="<%= filters && filters.selectedPriceRanges.includes('1000-1500') ? 'filter-active' : '' %>">
                                                        <label class="checkbox-container">
                                                            <input type="checkbox" 
                                                                   class="auto-filter" 
                                                                   name="price" 
                                                                   value="1000-1500"
                                                                   <%= filters && filters.selectedPriceRanges.includes('1000-1500') ? 'checked' : '' %>>
                                                            â‚¹1000.00 - â‚¹1500.00
                                                        </label>
                                                    </li>
                                                    <li class="<%= filters && filters.selectedPriceRanges.includes('1500-100000') ? 'filter-active' : '' %>">
                                                        <label class="checkbox-container">
                                                            <input type="checkbox" 
                                                                   class="auto-filter" 
                                                                   name="price" 
                                                                   value="1500-100000"
                                                                   <%= filters && filters.selectedPriceRanges.includes('1500-100000') ? 'checked' : '' %>>
                                                            â‚¹1500.00+
                                                        </label>
                                                    </li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>    
                            </div>
                        </div>
                        
                        <!-- Clear Filters Button - Moved to bottom -->
                        <% if (filters && (filters.selectedCategories.length > 0 || filters.selectedBrands.length > 0 || filters.selectedPriceRanges.length > 0 || filters.search || filters.sort)) { %>
                            <div class="mt-3">
                                <button type="button" class="clear-filters-btn w-100" onclick="clearAllFilters()">
                                    <i class="fas fa-times"></i> Clear All Filters
                                </button>
                            </div>
                        <% } %>
                    </div>
                    
                    <!-- Loading indicator -->
                    <div class="filter-loading" id="loadingIndicator">
                        <i class="fa fa-spinner"></i> Loading...
                    </div>
                </div>
            </div>
          
            <div class="col-lg-9">
                <!-- Results Summary -->
                <div class="row mb-3">
                    <div class="col-12">
                        <div class="d-flex justify-content-between align-items-center flex-wrap">
                            <div class="results-summary">
                                <p class="mb-0 text-muted">
                                    Showing <%= ((currentPage - 1) * 9) + 1 %>-<%= Math.min(currentPage * 9, totalProducts) %> 
                                    of <%= totalProducts %> products
                                    <% if (filters && (filters.search || filters.selectedCategories.length > 0 || filters.selectedBrands.length > 0 || filters.selectedPriceRanges.length > 0)) { %>
                                        (filtered)
                                    <% } %>
                                </p>
                            </div>
                            <div class="view-options d-none d-md-block">
                                <small class="text-muted">Page <%= currentPage %> of <%= totalPages %></small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Products Grid -->
                <div class="row" id="products-container">
                    <% if (products && products.length > 0) { %>
                        <% for(let i=0; i<products.length; i++) { %>
                            <div class="col-6 col-sm-6 col-md-6 col-lg-4">                       
                                <div class="product__item">
                                    <a href="/productDetails?id=<%= products[i]._id %>">
                                        <div class="product__item__pic set-bg" data-setbg="<%= products[i].productImages[0] %>">
                                            <% if (products[i].productOffer > 0) { %>
                                                <div class="product__discount__label">
                                                    -<%= Math.round(((products[i].regularPrice - products[i].salePrice) / products[i].regularPrice) * 100) %>%
                                                </div>
                                            <% } %>
                                        </div>
                                    </a>
                                    <a href="/addToWishlist?id=<%= products[i]._id %>" class="wishlist-btn" title="Add to Wishlist">
                                        <i class="fas fa-heart"></i>
                                    </a>
                                    <div class="text-center">
                                        <!-- Sale price and Regular price in one line -->
                                        <div class="d-flex justify-content-center align-items-center gap-2 mb-1 flex-wrap">
                                            <h5 class="text-dark fw-bold m-0">â‚¹<%= products[i].salePrice.toLocaleString('en-IN') %></h5>
                                            <% if (products[i].regularPrice > products[i].salePrice) { %>
                                                <span class="text-muted text-decoration-line-through small">
                                                    â‚¹<%= products[i].regularPrice.toLocaleString('en-IN') %>
                                                </span>
                                            <% } %>
                                        </div>

                                        <!-- Product name and brand in one line -->
                                        <div class="d-flex justify-content-center align-items-center flex-wrap gap-1 mb-1">
                                            <h6 class="text-dark fw-semibold m-0"><%= products[i].productName %></h6>
                                            <span class="small text-muted">| <%= products[i].brand %></span>
                                        </div>
                                        <p class="text-secondary small m-0">
                                            <%= products[i].description.length > 30 ? products[i].description.slice(0, 30) + '...' : products[i].description %>
                                        </p>
                                    </div>
                                </div>
                            </div>
                        <% } %>
                    <% } else { %>
                        <!-- No Products Found -->
                        <div class="col-12">
                            <div class="text-center py-5">
                                <i class="fas fa-search fa-3x text-muted mb-3"></i>
                                <h4 class="text-muted">No products found</h4>
                                <p class="text-muted">Try adjusting your filters or search terms</p>
                                <% if (filters && (filters.selectedCategories.length > 0 || filters.selectedBrands.length > 0 || filters.selectedPriceRanges.length > 0 || filters.search || filters.sort)) { %>
                                    <button type="button" class="btn btn-outline-primary" onclick="clearAllFilters()">
                                        Clear All Filters
                                    </button>
                                <% } %>
                            </div>
                        </div>
                    <% } %>
                </div>

                <!-- Pagination -->
                <% if (totalPages > 1) { %>
                    <div class="row">
                        <div class="col-lg-12">
                            <div class="product__pagination" id="pagination-container">
                                <% if (currentPage > 1) { %>
                                    <% 
                                        const prevParams = new URLSearchParams();
                                        if (filters && filters.sort) prevParams.set('sort', filters.sort);
                                        if (filters && filters.search) prevParams.set('search', filters.search);
                                        if (filters && filters.selectedCategories) filters.selectedCategories.forEach(cat => prevParams.append('category', cat));
                                        if (filters && filters.selectedBrands) filters.selectedBrands.forEach(brand => prevParams.append('brand', brand));
                                        if (filters && filters.selectedPriceRanges) filters.selectedPriceRanges.forEach(price => prevParams.append('price', price));
                                        prevParams.set('page', currentPage - 1);
                                    %>
                                    <a href="/shop?<%= prevParams.toString() %>"><</a>
                                <% } %>
                                
                                <% for (let i = 1; i <= totalPages; i++) { %>
                                    <% 
                                        const pageParams = new URLSearchParams();
                                        if (filters && filters.sort) pageParams.set('sort', filters.sort);
                                        if (filters && filters.search) pageParams.set('search', filters.search);
                                        if (filters && filters.selectedCategories) filters.selectedCategories.forEach(cat => pageParams.append('category', cat));
                                        if (filters && filters.selectedBrands) filters.selectedBrands.forEach(brand => pageParams.append('brand', brand));
                                        if (filters && filters.selectedPriceRanges) filters.selectedPriceRanges.forEach(price => pageParams.append('price', price));
                                        pageParams.set('page', i);
                                    %>
                                    <% if (currentPage === i) { %>
                                        <a class="active" href="/shop?<%= pageParams.toString() %>"><%= i %></a>
                                    <% } else { %>
                                        <a href="/shop?<%= pageParams.toString() %>"><%= i %></a>
                                    <% } %>
                                <% } %>
                                
                                <% if (currentPage < totalPages) { %>
                                    <% 
                                        const nextParams = new URLSearchParams();
                                        if (filters && filters.sort) nextParams.set('sort', filters.sort);
                                        if (filters && filters.search) nextParams.set('search', filters.search);
                                        if (filters && filters.selectedCategories) filters.selectedCategories.forEach(cat => nextParams.append('category', cat));
                                        if (filters && filters.selectedBrands) filters.selectedBrands.forEach(brand => nextParams.append('brand', brand));
                                        if (filters && filters.selectedPriceRanges) filters.selectedPriceRanges.forEach(price => nextParams.append('price', price));
                                        nextParams.set('page', currentPage + 1);
                                    %>
                                    <a href="/shop?<%= nextParams.toString() %>">></a>
                                <% } %>
                            </div>
                        </div>
                    </div>
                <% } %>
            </div>
        </div>
    </div>
</section>

<!-- Include the JavaScript file -->
<script src="/js/shop-filters.js"></script>

<!-- Additional CSS -->
<link rel="stylesheet" href="/css/shop-filters.css">

<script>
// Debounce utility function
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

document.addEventListener('DOMContentLoaded', function() {
    // Get DOM elements
    const searchInput = document.getElementById('searchInput');
    const searchBtn = document.getElementById('searchBtn');
    const filterCheckboxes = document.querySelectorAll('.auto-filter');

    // Mobile filter functionality
    const mobileFilterBtn = document.getElementById('mobileFilterBtn');
    const filterSidebar = document.getElementById('filterSidebar');
    const closeSidebarBtn = document.getElementById('closeSidebarBtn');

    // Mobile filter toggle
    if (mobileFilterBtn) {
        mobileFilterBtn.addEventListener('click', function() {
            filterSidebar.classList.add('active');
            document.body.classList.add('overflow-hidden');
        });
    }

    if (closeSidebarBtn) {
        closeSidebarBtn.addEventListener('click', function() {
            filterSidebar.classList.remove('active');
            document.body.classList.remove('overflow-hidden');
        });
    }

    // Initialize filters from URL parameters
    initializeFiltersFromURL();

    // Create debounced search function (500ms delay)
    const debouncedSearch = debounce(function() {
        console.log('ðŸ” Debounced search triggered');
        applyFilters();
    }, 500);

    // Event listeners - SIMPLE APPROACH LIKE WORKING PROJECT
    if (searchBtn) {
        searchBtn.addEventListener('click', applyFilters);
    }
    
    if (searchInput) {
        // Remove the old keypress listener and add input listener with debouncing
        searchInput.addEventListener('input', function() {
            console.log('âŒ¨ï¸ Search input changed, debouncing...');
            debouncedSearch();
        });
        
        // Keep Enter key for immediate search
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                console.log('â†µ Enter pressed, immediate search');
                applyFilters();
            }
        });
    }

    filterCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', applyFilters);
    });

    // Functions - SIMPLE APPROACH LIKE WORKING PROJECT
    function initializeFiltersFromURL() {
        const urlParams = new URLSearchParams(window.location.search);
        
        // Set search value
        const searchValue = urlParams.get('search') || '';
        if (searchInput) {
            searchInput.value = searchValue;
        }
        
        // Set filter checkboxes
        const categories = urlParams.getAll('category');
        const brands = urlParams.getAll('brand');
        const prices = urlParams.getAll('price');
        
        filterCheckboxes.forEach(checkbox => {
            const name = checkbox.name;
            const value = checkbox.value;
            
            checkbox.checked = false; // Reset first
            
            if (name === 'category' && categories.includes(value)) {
                checkbox.checked = true;
            } else if (name === 'brand' && brands.includes(value)) {
                checkbox.checked = true;
            } else if (name === 'price' && prices.includes(value)) {
                checkbox.checked = true;
            }
        });
    }

    // SIMPLE APPLY FILTERS FUNCTION - EXACTLY LIKE WORKING PROJECT
    function applyFilters() {
        const url = new URL(window.location.href);
        const params = url.searchParams;

        // Reset to first page
        params.set('page', '1');

        // Get selected categories
        const selectedCategories = Array.from(document.querySelectorAll('input[name="category"]:checked'))
            .map(cb => cb.value);

        // Get selected brands
        const selectedBrands = Array.from(document.querySelectorAll('input[name="brand"]:checked'))
            .map(cb => cb.value);

        // Get selected price ranges
        const selectedPriceRanges = Array.from(document.querySelectorAll('input[name="price"]:checked'))
            .map(cb => cb.value);

        // Get search value
        const searchValue = document.getElementById('searchInput').value.trim();

        // Get sort value
        const sortValue = document.getElementById('sortSelect').value;

        // Clear existing parameters
        params.delete('category');
        params.delete('brand');
        params.delete('price');
        params.delete('search');
        params.delete('sort');

        // Add new parameters
        if (selectedCategories.length > 0) {
            selectedCategories.forEach(cat => params.append('category', cat));
        }
        if (selectedBrands.length > 0) {
            selectedBrands.forEach(brand => params.append('brand', brand));
        }
        if (selectedPriceRanges.length > 0) {
            selectedPriceRanges.forEach(price => params.append('price', price));
        }
        if (searchValue) {
            params.set('search', searchValue);
        }
        if (sortValue) {
            params.set('sort', sortValue);
        }

        console.log('ðŸŒ Applying filters, new URL:', url.toString());
        window.location.href = url.toString();
    }

    // Make functions globally available
    window.applyFilters = applyFilters;
});

// SIMPLE SORT FUNCTION - EXACTLY LIKE WORKING PROJECT
function sortProducts() {
    const sortValue = document.getElementById('sortSelect').value;
    console.log('ðŸ”„ Sort changed to:', sortValue);
    
    const url = new URL(window.location.href);
    url.searchParams.set('sort', sortValue);
    window.location.href = url.toString();
}

// Global utility function to clear all filters
function clearAllFilters() {
    console.log('ðŸ§¹ Clearing all filters...');
    
    const sortSelect = document.getElementById('sortSelect');
    const searchInput = document.getElementById('searchInput');
    const filterCheckboxes = document.querySelectorAll('.auto-filter');
    
    // Reset form elements
    if (sortSelect) sortSelect.value = '';
    if (searchInput) searchInput.value = '';
    
    filterCheckboxes.forEach(checkbox => {
        checkbox.checked = false;
    });
    
    // Redirect to clean shop page
    window.location.href = '/shop';
}
</script>

<%- include("../../views/partials/user/footer") %>